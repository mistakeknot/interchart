name: Regenerate Ecosystem Diagram

on:
  schedule:
    # Every 6 hours
    - cron: '0 */6 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  generate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout interchart
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Discover repos
        id: discover
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Fetch all public repos for mistakeknot (paginate)
          REPOS=$(gh api --paginate '/users/mistakeknot/repos?per_page=100&type=public' --jq '.[].name' | sort)
          echo "Found $(echo "$REPOS" | wc -l) repos total"

          # Classify repos into monorepo locations
          PLUGINS=""
          HUB=""
          SERVICES=""
          SKIP="Interverse interchart"

          for repo in $REPOS; do
            # Skip non-ecosystem repos
            case "$repo" in
              Interverse|interchart) continue ;;
            esac

            # Known fixed mappings
            case "$repo" in
              Clavain)   HUB="$repo"; continue ;;
              intermute) SERVICES="$repo"; continue ;;
            esac

            # Anything starting with inter* or known plugin names → plugin
            case "$repo" in
              inter*|tldr-swinton|tool-time|tuivision)
                PLUGINS="${PLUGINS} ${repo}"
                ;;
            esac
          done

          echo "Plugins:${PLUGINS}"
          echo "Hub: ${HUB}"
          echo "Services: ${SERVICES}"
          echo "plugins=${PLUGINS}" >> "$GITHUB_OUTPUT"
          echo "hub=${HUB}" >> "$GITHUB_OUTPUT"
          echo "services=${SERVICES}" >> "$GITHUB_OUTPUT"

      - name: Assemble monorepo tree
        run: |
          mkdir -p workspace/plugins workspace/hub workspace/services workspace/Interforge

          # Clone all discovered plugins in parallel
          for p in ${{ steps.discover.outputs.plugins }}; do
            git clone --depth 1 --single-branch "https://github.com/mistakeknot/${p}.git" "workspace/plugins/${p}" 2>/dev/null &
          done

          # Clone hub
          if [ -n "${{ steps.discover.outputs.hub }}" ]; then
            git clone --depth 1 --single-branch "https://github.com/mistakeknot/${{ steps.discover.outputs.hub }}.git" workspace/hub/clavain 2>/dev/null &
          fi

          # Clone services
          if [ -n "${{ steps.discover.outputs.services }}" ]; then
            git clone --depth 1 --single-branch "https://github.com/mistakeknot/${{ steps.discover.outputs.services }}.git" workspace/services/intermute 2>/dev/null &
          fi

          wait

          PLUGIN_COUNT=$(ls workspace/plugins 2>/dev/null | wc -l)
          echo "Assembled ${PLUGIN_COUNT} plugins + hub + services"

      - name: Generate diagram
        run: |
          mkdir -p dist
          node scripts/scan.js workspace > dist/scan.json
          NODE_COUNT=$(node -e "let d='';process.stdin.on('data',c=>d+=c);process.stdin.on('end',()=>console.log(JSON.parse(d).stats.nodes))" < dist/scan.json)
          EDGE_COUNT=$(node -e "let d='';process.stdin.on('data',c=>d+=c);process.stdin.on('end',()=>console.log(JSON.parse(d).stats.edges))" < dist/scan.json)
          echo "Scanned: ${NODE_COUNT} nodes, ${EDGE_COUNT} edges"

          node -e "
            const fs = require('fs');
            const tmpl = fs.readFileSync('templates/ecosystem.html', 'utf8');
            const data = fs.readFileSync('dist/scan.json', 'utf8');
            fs.writeFileSync('dist/index.html', tmpl.replace('/*DATA_PLACEHOLDER*/', data.trim()));
          "
          rm dist/scan.json
          echo "Generated dist/index.html ($(wc -c < dist/index.html) bytes)"

      - name: Check for changes
        id: diff
        run: |
          if git show origin/gh-pages:index.html > /tmp/old.html 2>/dev/null; then
            OLD_NODES=$(grep -o '"nodes":[0-9]*' /tmp/old.html | head -1)
            NEW_NODES=$(grep -o '"nodes":[0-9]*' dist/index.html | head -1)
            OLD_EDGES=$(grep -o '"edges":[0-9]*' /tmp/old.html | head -1)
            NEW_EDGES=$(grep -o '"edges":[0-9]*' dist/index.html | head -1)
            if [ "$OLD_NODES" = "$NEW_NODES" ] && [ "$OLD_EDGES" = "$NEW_EDGES" ]; then
              echo "No structural changes (same node/edge counts)"
              echo "changed=false" >> "$GITHUB_OUTPUT"
            else
              echo "Changes: nodes $OLD_NODES -> $NEW_NODES, edges $OLD_EDGES -> $NEW_EDGES"
              echo "changed=true" >> "$GITHUB_OUTPUT"
            fi
          else
            echo "No previous version — first deploy"
            echo "changed=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Deploy to gh-pages
        if: steps.diff.outputs.changed == 'true' || github.event_name == 'workflow_dispatch'
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: dist
          keep_files: false
